---
title: "MY472_Final"
author: "CT-Dev1"
date: "01/01/2024"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_packages, eval = TRUE}
#Load required packages
library(ukpolice)
library(tidyverse)
library(sf)
library(sp)
library(httr)
library(jsonlite)
library(RSQLite)
library(httr)
library(netstat)
library(texreg)
#library(gtsummary)
```

```{r load_data, eval = TRUE}
#Ethnicity Population Data by LSOAs (downloaded from office for national statistics - 2021 data)
ethnicity_data <- read.csv("data\\LSOA_ethnicity.csv")

#Sex and Age Population Data For England and Wales
pop_by_sex_age <- read.csv("data\\pop_by_sex_age.csv")

#Local District Shape Files from GeoJSON
LSOA_shapes <- st_read("data\\LSOA_shapefiles.geojson")

#Police Force Shape files from GeoJSON
pf_shapes <- st_read("data\\force_areas_shapefiles.geojson")
```

```{r clean_data, eval = TRUE}
#Create table for LSOAs by police force area
LSOA_by_force <- LSOA_shapes %>% 
  st_centroid() %>% 
  st_join(pf_shapes, join = st_intersects) %>% 
  as_tibble() %>%
  select(c(LSOA21CD, LSOA21NM, pfa16cd, pfa16nm)) %>% 
  rename(LSOA_code = LSOA21CD, LSOA_name = LSOA21NM, force_code = pfa16cd, force_name = pfa16nm)

#Create table for population by ethnicity for LSOA
ethnicity_by_LSOA <- ethnicity_data %>% 
  rename(LSOA_code = Lower.layer.Super.Output.Areas.Code, LSOA_name = Lower.layer.Super.Output.Areas, ethnic_group = Ethnic.group..20.categories.) %>%
  select(LSOA_code, Observation, ethnic_group) %>%
  pivot_wider(names_from = ethnic_group, values_from = Observation) %>% 
  mutate(total_pop = rowSums(across(where(is.numeric))))

#Joining the two tables
ethnicity_by_force <- LSOA_by_force %>% 
  full_join(ethnicity_by_LSOA, by = "LSOA_code") %>% 
  group_by(force_code, force_name) %>%
  mutate(force_name = str_replace_all(force_name, " Police", "")) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE))

#Cleaning the age and sex population data
pop_by_sex_age <- pop_by_sex_age %>% 
  select(Sex..2.categories., Age..91.categories..Code, Observation) %>% 
  rename(gender = Sex..2.categories., age = Age..91.categories..Code, population = Observation) %>% 
  mutate(population_percent = (population/sum(population))*100)

```

```{r get_ss_data, eval = TRUE}
#Create table that relates API input, force name and force code in standard format
police_forces <- ukc_forces()%>% 
  rename(force_name = name, ukc_input = id)%>% 
  mutate(force_name = str_replace_all(force_name, " Police", "")) %>% 
  mutate(force_name = str_replace_all(force_name, " Constabulary", "")) %>% 
  mutate(force_name = str_replace_all(force_name, "&", "and")) %>%
  mutate(force_name = str_replace_all(force_name, " Service", "")) %>%
  inner_join(ethnicity_by_force, by = "force_name") %>% 
  select(force_name, ukc_input, force_code)

#Vector of months to loop through, input into API
dates <- c("2022-01","2022-02","2022-03","2022-04","2022-05","2022-06","2022-07","2022-08","2022-09","2022-10","2022-11","2022-12")
```


```{r get_ss_data_2, eval = FALSE}
#Function to clean the raw data from API
clean_ss_data <- function(ss_data, force, month) {
  force_data <- ss_data %>% 
    mutate(ukc_input = force) %>% 
    inner_join(police_forces, by = "ukc_input") %>% 
    select(age_range, gender, self_defined_ethnicity, officer_defined_ethnicity, legislation, object_of_search, outcome_object_name, legislation, force_code, force_name, ukc_input, latitude, longitude, street_id, street_name) %>% 
    mutate(self_defined_ethnicity = ifelse(grepl("Not stated", self_defined_ethnicity), NA, self_defined_ethnicity)) %>% 
    mutate(racial_group = ifelse(is.na(self_defined_ethnicity), officer_defined_ethnicity, self_defined_ethnicity)) %>% 
    #Add column for racial_group based on ethnicity classification
    mutate(racial_group = ifelse(grepl("White", racial_group, fixed = TRUE), 'White',
                           ifelse(grepl("Asian", racial_group, fixed = TRUE), 'Asian',
                           ifelse(grepl("Black", racial_group, fixed = TRUE), 'Black',
                           ifelse(grepl("Mixed", racial_group, fixed = TRUE), 'Mixed',
                           ifelse(grepl("Other", racial_group, fixed = TRUE), 'Other', NA)))))) %>% 
    mutate(month = month)
  return(force_data)
}

#Script to download stop and search data for all police forces over 2022

#Empty tibble to store the data
stop_search_2022 <- ukc_stop_search_force("bedfordshire","2022-01") %>%
  clean_ss_data("bedfordshire", "2022-01") %>%
  slice(0)

#table to store missing forces and months
missing_data = tibble(ukc_input = character(), month = character())

#Loop over all police forces and months
for (month in dates){
  for (force in police_forces$ukc_input){
    print(c(force, month))
    force_data <- ukc_stop_search_force(force, month)
    if (length(force_data)==0 | is.null(force_data)){
      missing_data <- missing_data %>% 
        add_row(ukc_input = force, month = month)
      next
    } else {
    stop_search_2022 <- force_data %>% 
      clean_ss_data(force, month) %>%
      rbind(stop_search_2022)
    }}
  Sys.sleep(3) 
}

```


```{r partial_missing_data_fill, eval = FALSE}
#There is missing data, so investigate police API issue log at https://data.police.uk/changelog/
#Some forces have partial missing data for 2022, so we will utilize forward propagation to fill in the data

#Create table of partial missing data
partial_missing_forces <- missing_data %>% 
  filter(ukc_input %in% c("greater-manchester","gwent", "north-yorkshire")==FALSE) %>% 
  mutate(month_index = as.numeric(str_replace_all(month, "2022-", ""))) 

#create table of inputs for forward propagation
forward_prop_input <- missing_data %>% 
  filter(ukc_input %in% c("greater-manchester","gwent", "north-yorkshire")==FALSE) %>% 
  group_by(ukc_input) %>%
  summarize(missing_months = n()) %>% 
  inner_join(police_forces, by = "ukc_input")

#Script to loop over missing data by force and month

for (force in forward_prop_input$ukc_input){
  missing_months <- forward_prop_input$missing_months[forward_prop_input$ukc_input==force]
  last_record_month <- min(partial_missing_forces$month_index[partial_missing_forces$ukc_input==force]) -1
  month_input <- paste0("2022-", last_record_month)
  for (i in 1:forward_prop_input$missing_months[forward_prop_input$ukc_input==force]){
    force_data <- ukc_stop_search_force(force, month_input)
    month_filled_input <- paste0("2022-", last_record_month+i)
    stop_search_2022 <- force_data %>% 
      clean_ss_data(force, month_filled_input) %>%
      rbind(stop_search_2022)
  }
}

#Write to disk, this is commented out, data is stored in stop_search_2022.csv in data folder (within the github)
write_csv(stop_search_2022, "stop_search_2022.csv")

```


```{r load_ss_data, eval = TRUE}
#Load full dataset from csv, which is only missing data for Greater Manchester, Gwent and North Yorkshire, these I add manually at later stages
stop_search_2022 <- read_csv("data//stop_search_2022.csv")
```

```{r missing_data_test, eval = FALSE}
#test that forward propagation worked using the test case of South Wales, which previously had some missing data
'
stop_search_2022 %>% 
  filter(force_name == "South Wales") %>% 
  group_by(month) %>% 
  summarize(total_stops = n()) %>% 
  print()

#Demonstration that API fails for some forces - greater manchester, gwent and north yorkshire
url <- "https://data.police.uk/api/stops-force?force=greater-manchester&date=2022-02"
json <- content(GET(url), "parsed")
print(is.null(json)|length(json)==0)
'
```

```{r}
#format the sex and age population stats to match the format in police.uk data
pop_sex_age_formatted <- pop_by_sex_age %>% 
  mutate(age_range = ifelse(age < 10, "under 10", 
                    ifelse(age <=17, "10-17", 
                     ifelse(age <=24, "18-24",
                    ifelse(age <= 34, "25-34", "over 34"))))) %>% 
  group_by(age_range, gender) %>%
  summarize(population = sum(population), population_percent=sum(population_percent))
  
#Stop rates by sex and age
stops_by_age_and_sex <- stop_search_2022 %>% 
  filter(is.na(age_range)==FALSE) %>% 
  group_by(age_range, gender) %>%
  summarize(stops_recorded = n()) %>% 
  filter(gender %in% c("Male", "Female")) %>% 
  #total stops is 426768 (stops with recorded age_range data)
  mutate(percentage_stops = (stops_recorded/426768)*100) %>% 
  inner_join(pop_sex_age_formatted, by = join_by(age_range, gender))

age_gender_percent_stops <- stops_by_age_and_sex %>% 
  select(age_range, gender, percentage_stops) %>% 
  mutate(gender = paste0("stops-", gender)) %>% 
  rename(percentage = percentage_stops)

age_sex_stops_population <- stops_by_age_and_sex %>% 
  select(age_range, gender, population_percent) %>% 
  mutate(population_percent = -1*population_percent) %>% 
  mutate(gender = paste0("population-", gender)) %>% 
  rename(percentage = population_percent) %>% 
  rbind(age_gender_percent_stops) %>% 
  filter(age_range != "under 10")

stops_by_age_and_sex_histogram <- age_sex_stops_population %>% 
  ggplot(aes(x = age_range, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "stack", width = 0.50) +
  scale_y_continuous(breaks = seq(-60, 60, by = 10), labels = abs(seq(-60,60,by=10)), limits = c(-60,60)) +
  geom_hline(yintercept = 0, linetype = "solid", color = "black", size = 1) +
  coord_flip() +
  scale_fill_manual(values = c("population-Female" = "gray55", "stops-Female" = "gray55", "population-Male" = "gray25", "stops-Male" = "gray25"),
                      breaks = c("population-Female", "population-Male"),
                      labels = c("Female", "Male")) + 
  theme(aspect.ratio = 3/9, axis.text.y = element_text(angle = 0, hjust = 1)) +
  ylab("Percent") +
  xlab("Age Group") +
  ggtitle(str_wrap("Proportion of stop and search by age and sex of person compared with the population", width=80), "England and Wales | 2022 | Based on 426,768 total searches") +
  annotate("text", x = 1, y = 50, label = "Proportion of Stop\nand Search in each \nage group", vjust = -1, size = 3) +
  annotate("text", x = 1, y = -30, label = "Proportion of \nPopulation in each \nage group", vjust = -1, size = 3) +
  labs(fill = "Sex")
  
stops_by_age_and_sex_histogram
```


```{r total_missing_data_fill, eval = TRUE}
#North Yorkshire, Gwent and Greater Manchester have no ethnicity data at all for any period
#Given this, can extract from alternative data source, Home office stop and search by ethnicity of 2022

#download this missing data from gov.uk - this was done previously, data stored in missing_forces_stop_search.csv

#url <- "https://www.ethnicity-facts-figures.service.gov.uk/crime-justice-and-the-law/policing/stop-and-search/latest/downloads/stop-and-search-#data-2006-2022.csv"
#download.file(url, destfile = "missing_forces_stop_search.csv")
missing_forces_ss <- read.csv("data/missing_forces_stop_search.csv")

#Process the data to filter for the missing police forces, keep it for later use to input missing data
#Full data set
missing_forces_to_input <- missing_forces_ss %>% 
  rename(number_of_stop_and_searches_ethnicity_reported = total_number_of_stop_and_search_carried_out_in_this_year_in_this_area_excluding_cases_where_the_ethnicity_was_unreported, stop_search_rate_ethnicity = proportion_of_total_stop_and_searches_of_this_ethnicity_in_the_financial_year_excludes_unreported) %>%
  mutate(time = as.character(time)) %>% 
  filter(geography %in% c("Gwent", "Greater Manchester", "North Yorkshire")==TRUE) %>% 
  filter(geography_type == "Police Force Area" & time == "2021/22") %>% 
  select(ethnicity, geography, number_of_stop_and_searches, number_of_stop_and_searches_ethnicity_reported, population_by_ethnicity, rate_per_1_000_population_by_ethnicity, stop_search_rate_ethnicity)

#Total rate by force (for Gwent, Manchester, N Yorkshire)
missing_forces_ss_rate <- missing_forces_to_input %>% 
  select(ethnicity, geography, population_by_ethnicity, number_of_stop_and_searches)
```

```{r ss_by_race_tables, eval = TRUE}
#race populations by force area
race_by_force <- ethnicity_by_force %>% 
  pivot_longer(cols = -c(force_code,force_name), names_to = "racial_group", values_to = "population") %>% 
  mutate(racial_group = ifelse(grepl("White", racial_group, fixed = TRUE), 'White',
                       ifelse(grepl("Asian", racial_group, fixed = TRUE), 'Asian',
                       ifelse(grepl("Black", racial_group, fixed = TRUE), 'Black',
                       ifelse(grepl("Mixed", racial_group, fixed = TRUE), 'Mixed',
                       ifelse(grepl("Other", racial_group, fixed = TRUE), 'Other', NA)))))) %>%
  group_by(force_name, racial_group) %>% 
  summarize(population = sum(population[racial_group==racial_group])) %>% 
  filter(is.na(racial_group)==FALSE) %>%
  pivot_wider(names_from = racial_group, values_from = "population", names_prefix = "population_") %>% 
  mutate(population_Total = population_White + population_Black + population_Mixed + population_Asian + population_Other) %>%
  inner_join(police_forces, by = "force_name")

#rate of stop and search by race
race_stops_data <- stop_search_2022 %>% 
  mutate(self_defined_ethnicity = ifelse(grepl("Not stated", self_defined_ethnicity), NA, self_defined_ethnicity)) %>% 
  filter(is.na(self_defined_ethnicity)==FALSE) %>%
  group_by(force_name) %>% 
  summarize(total_stops_ethnicity_reported = n(), black_stops = sum(racial_group=="Black"), white_stops = sum(racial_group=="White"), mixed_stops = sum(racial_group=="Mixed"), asian_stops = sum(racial_group=="Asian"), other_stops = sum(racial_group=="Other")) %>%  
  inner_join(police_forces, by = "force_name") %>%
  inner_join(race_by_force, by = c("force_name","force_code")) %>% 
  mutate(stop_rate_black = (black_stops/population_Black)*1000, stop_rate_white = (white_stops/population_White)*1000, stop_rate_mixed = (mixed_stops/population_Mixed)*1000, stop_rate_asian = (asian_stops/population_Asian)*1000, stop_rate_other = (other_stops/population_Other)*1000, stop_rate_total = (total_stops_ethnicity_reported/population_Total)*1000)
```
- add number of stop and searches no ethnicity reported
-note that the rate is based on the number of stops where ethnicity is reported, this can change the rate significantly
- in the above, the total stop and searches are those with no ethnicity reported

```{r visualize_total_ss_rate, eval=TRUE}
#Visualizing search rate by police force area

#total stops by force for N yorkshire, Gwent and Greater Manchester (The missing data)
total_stops_man_gwent_yorkshire <- missing_forces_to_input %>% 
  select(geography, number_of_stop_and_searches, ethnicity) %>%
  group_by(geography) %>%
  summarize(total_stops = sum(number_of_stop_and_searches[ethnicity == ethnicity])) %>% 
  rename(force_name = geography)

#Total stops by force (complete data)
ss_rate_by_force <- stop_search_2022 %>% 
  group_by(force_name) %>%
  summarize(total_stops = n()) %>% 
  rbind(total_stops_man_gwent_yorkshire) %>% 
  inner_join(race_by_force, by = c("force_name")) %>%
  mutate(stop_rate_total = (total_stops/population_Total)*1000) %>%
  select(force_name, stop_rate_total) %>% 
  #Exclude City of London, as it is an outlier, it skews the graph range, mkaing variability invisible
  filter(force_name != "City of London") 


#Visualizing the  total stop rate by PFA on a map
total_stop_rate_map <- pf_shapes %>% 
  rename(force_name = pfa16nm) %>% 
  mutate(force_name = ifelse(force_name=="Metropolitan Police", "Metropolitan", force_name)) %>%
  filter(force_name != "City of London") %>%
  inner_join(ss_rate_by_force, by = "force_name") %>% 
  ggplot(aes(fill = stop_rate_total)) +
  geom_sf() +
  scale_fill_viridis_c(option = "plasma", direction = -1, na.value = "grey90", name = "Stop and search rate per 1000 people") +
  theme_void() +
  theme(legend.position = "bottom") +
  labs(title = "Stop and Search Rate by Police Force Area", subtitle = "2021/22", caption = "Source: Police.uk, 2022, based on number of searches that recorded racial/ethnicity data")

total_stop_rate_map  #display the map
```

```{r}
#Displaying via histogram

#Order forces in descending order by stop rate
ss_rate_by_force$force_name <- factor(ss_rate_by_force$force_name, levels = ss_rate_by_force$force_name[order(-ss_rate_by_force$stop_rate_total)])

#Generate Bar plot
total_stop_rate_histogram <- ggplot(ss_rate_by_force, aes(x = force_name, y = stop_rate_total)) +
  geom_bar(stat = "identity", color = "black", fill = "lightblue", width = 0.8) + # Increase bar spacing by reducing width
  scale_y_continuous(expand = c(0,0), limits = c(0, 40), breaks = seq(0, 40, by = 10)) + # Set y-axis limits and breaks
  theme_minimal(base_size = 10) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 6), # Rotate and adjust the font size
        axis.title = element_text(size = 12), # Adjust the axis title font size if needed
        panel.grid.major = element_line(color = "gray", size = 0.5), # Add major grid lines
        panel.grid.minor = element_blank(), # Disable minor grid lines
        panel.background = element_rect(fill = "white"),axis.line = element_line(color = "black")) +  # Add axis lines
  labs(title = "Stop Search Rate by Police Force Area",
       subtitle = "England and Wales, 2022",
       x = "Police Force Area (PFA)",
       y = "Searches per 1000 residents")

total_stop_rate_histogram
```

Notes on above:
- We exclude the City of London due to the number of people who visit compared to the small number of people who live there

```{r visualize_total_ss_rate, eval=TRUE}
#Now we can visualize the racial search data

#Summary table - race stop rates by force
race_stops_data %>% 
  select(force_name, stop_rate_black, stop_rate_white, stop_rate_mixed, stop_rate_asian, stop_rate_other, stop_rate_all_races, stops_rate_Total) %>%
  rename("Police Force" = force_name, Black = stop_rate_black, White = stop_rate_white, Mixed = stop_rate_mixed, Asian = stop_rate_asian, Other = stop_rate_other, "All Races*" = stop_rate_all_races, "Total Stops**" = stops_rate_Total) %>%
  gt() %>% 
  fmt_number(columns = c(everything()), decimals = 2) %>%
  tab_header(title = md("**Rates of Stop and Search by Racial Group and Police Force Area**")) %>% tab_spanner(label = md("**Rate per 1000 Residents in 2022**"), columns = c(2:8)) %>% 
  opt_row_striping() %>% 
  tab_footnote(
    footnote = "
    *'All Races' is the rate for all stops where racial data is recorded | **'Total stops' is the rate for all stops recorded"
  ) %>% 
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = list(cells_column_labels(columns = everything()), cells_body(columns = c(1))))
```
FORMAT PAPER --> https://www.ethnicity-facts-figures.service.gov.uk/crime-justice-and-the-law/policing/stop-and-search/latest/


Notes on table above:
- Demonstrates stop and search rate varies significantly across areas
- Gives the outlier of City of London - it should be removed from further analysis
- Note that all races stop rate may be smaller than official statistics given that we are analysing on searches where race is known
- add column for demographic - number of total searches and population


```{r visualize_black_ss_rate, eval=TRUE}
library(viridis)
black_stop_rate_map <- pf_shapes %>% 
  inner_join(race_stops_data, by = c("force_name")) %>%
  select(force_name, stop_rate_black, stop_rate_white) %>% 
  mutate(black_white_ratio = stop_rate_black/stop_rate_white) %>%
  #black_white_ratio defaults to 5 when above 5 for the graphical representation
  #mutate(black_white_ratio = ifelse(black_white_ratio > 5, 5, black_white_ratio)) %>%
  mutate(black_white_ratio = log(black_white_ratio)) %>%
  filter(force_name != "City of London") %>%
  ggplot(aes(fill = black_white_ratio)) + 
  geom_sf() +
  scale_fill_viridis_c(
    option = "plasma", 
    direction = -1, 
    na.value = "red", 
    name = "Log Likelihood of Stop-and-Search for Black vs. White",
    trans = "identity",
    limits = c(0, 3),
    breaks = c(0, 1, 2, 3) 
  ) +
  theme_void() +
  theme(legend.position = "bottom") +
  labs(title = "Difference in Search Rates by Force Area: Black vs. White", subtitle = "2022", caption = "Source: police.uk | Based on Total Stops Conducted | Log Likelihood of 0 represents 1:1 chance of being stopped")
black_stop_rate_map
```
- Fix the above map caption etc. - CENTRE THE TITLE
- Change the above to have a logarithmic scale instead of log variable


















Now, to run some statistical tests using linear regression
```{r regression_full_data, eval=TRUE}
#Table of stops by race by force, tidy long format
race_stops_data_long <- race_stops_data %>% 
  select(stop_rate_black, stop_rate_white, stop_rate_mixed, stop_rate_asian, stop_rate_other, force_name) %>%
  rename(Black = stop_rate_black, White = stop_rate_white, Mixed = stop_rate_mixed, Asian = stop_rate_asian, Other = stop_rate_other) %>%
  pivot_longer(cols = c(Black, White, Mixed, Asian, Other), names_to = "racial_group", values_to = "stops_rate_per_1000") %>% print()

#Data for regression - total population = the 
regression_data <- stop_search_2022 %>% 
  mutate(self_defined_ethnicity = ifelse(grepl("Not stated", self_defined_ethnicity), NA, self_defined_ethnicity)) %>% 
  filter(is.na(self_defined_ethnicity)==FALSE) %>%
  inner_join(race_stops_data_long, by = c("racial_group","force_name")) %>% 
  filter(force_name != "City of London") %>%
  mutate(racial_group = as_factor(racial_group), force_name = as_factor(force_name)) %>% 
  rename(Male = gender) %>% 
  mutate(Male = ifelse(Male == "Male", 1, 0)) 

#Multiple Linear Regression model, finding effect of race, force area, male gender on likelihood of being stopped 
#set the reference groups to be white for racial group and Kent for force area, as it has near-average stop and search rate (6.78 per 1000)
reg1 <- lm(stops_rate_per_1000 ~ relevel(racial_group, ref="White") + relevel(force_name, ref="Kent") + Male, data = regression_data)

#Tidy Present
screenreg(reg1)
```


To think about:
- Writing to database
- Get database on all stop and search data for time period for each police force 
- Then you can query it to get all the relevant statistics
- Instead of using crime statistics to determine if there is bias, you can look at the rate of arrest by stop and search


Notes on above:
- You'll have to replace the path with a path online - replicable - however all the data sources are the best available
- Remember to change the above ethnicity_data path to an original data source - its currently on the data you've pre-edited
- add in age data later on


Notes on above:
- If you have time, rename all the variables to be consistent across all dataframes
- Reference the fact that you tested the level of distortion so that it is not too extreme
- If you have time, put all the data frames into a SQL database and query it for analyses where local district code is the primary key



